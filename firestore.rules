/**
 * @file firestore.rules
 * @description Firestore Security Rules for the WodMatch platform.
 *
 * ## Core Philosophy
 * This ruleset enforces a strict, user-centric security model. The primary principle is that users have explicit ownership and control over their own data. Public data is explicitly marked as such, and all other access is denied by default. The rules are designed for performance and security by avoiding complex queries and favoring denormalized data for authorization checks.
 *
 * ## Data Structure
 * The data is organized into five top-level collections:
 * - `/users/{userId}`: Stores individual athlete profiles.
 * - `/boxes/{boxId}`: Publicly readable collection of gyms.
 * - `/user_roles/{userRoleId}`: Publicly readable definitions of user roles.
 * - `/athlete_roles/{athleteRoleId}`: Links users to roles.
 * - `/registrations/{registrationId}`: Stores event registrations.
 *
 * ## Key Security Decisions
 * - **Strict User Ownership**: Users can only CUD their own `/users/{userId}` doc and their own `/registrations` docs.
 * - **No User Listing**: Listing all users is forbidden to protect privacy.
 * - **Scoped Role & Registration Lookups**: Users can only list roles and registrations where their UID is specified in a query.
 * - **Public Read-Only Data**: `/boxes` and `/user_roles` are public reference data.
 * - **Organizer Read Access**: Event organizers can read registrations for their own events.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the fundamental check for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if a user is an organizer of a specific competition.
     * It reads the competition document to check the `organizerId`.
     */
    function isOrganizer(competitionId) {
      return isSignedIn() && get(/databases/$(database)/documents/competitions/$(competitionId)).data.organizerId == request.auth.uid;
    }

    /**
     * Ensures an operation is performed by the owner on an existing document.
     * CRITICAL for all update and delete operations to prevent modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user is creating their own user document and that the
     * internal `id` field is correctly set to their UID for data consistency.
     */
    function isCreatingSelf(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Enforces immutability for a specific field during an update.
     * Used to prevent changing critical, non-editable fields like ownership IDs.
     */
    function isFieldImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // ----------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------

    /**
     * @description Manages athlete profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isCreatingSelf(userId);
      allow update: if isExistingOwner(userId) && isFieldImmutable('id');
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Publicly readable event information. Client writes are limited to updating specific fields
     * like categories, handled by organizers.
     */
    match /competitions/{competitionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isOrganizer(competitionId);
      allow delete: if isOrganizer(competitionId);
    }

    /**
     * @description Public information about CrossFit boxes.
     */
    match /boxes/{boxId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Public definitions for user roles.
     */
    match /user_roles/{userRoleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Associates athletes with roles.
     */
     match /athlete_roles/{athleteRoleId} {
      allow get: if isSignedIn() && resource.data.athleteId == request.auth.uid;
      allow list: if isSignedIn() && request.query.where.get('athleteId', ['in', [request.auth.uid]]) != null;
      allow create: if isSignedIn() && request.resource.data.athleteId == request.auth.uid;
      allow update, delete: if false;
    }
    
    /**
     * @description Manages event registrations.
     * @allow (get) An athlete can get their own registration. An organizer can get any registration for their event.
     * @allow (list) An athlete can list their own registrations. An organizer can list all registrations for their event.
     * @allow (create) An athlete can create their own registration.
     * @allow (update) An athlete can update their own registration (e.g., to add payment proof). An organizer can update a registration (e.g., to approve/reject).
     */
    match /registrations/{registrationId} {
        allow get: if isSignedIn() && (resource.data.athleteId == request.auth.uid || isOrganizer(resource.data.competitionId));
        allow list: if isSignedIn(); // List queries must be filtered by athleteId or competitionId by the client.
        allow create: if isSignedIn() && request.resource.data.athleteId == request.auth.uid;
        allow update: if isSignedIn() && (
            (resource.data.athleteId == request.auth.uid) || // Owner can update
            isOrganizer(resource.data.competitionId)       // Organizer can update
        );
        allow delete: if false; // Deletions should be handled by status changes, not hard deletes.
    }
  }
}
